/*!
 * area-selector v1.0.2
 *
 * 作者：王金城
 * 日期：2020年3月31日
 */
(function(d){let constants={classes:{zoomInTopLeaveActive:"el-zoom-in-top-leave-active",zoomInTopEnter:"el-zoom-in-top-enter",zoomInTopEnterActive:"el-zoom-in-top-enter-active",isFocus:"is-focus",cascader:"cascader",elPopper:"el-popper",popperArrow:"popper__arrow",activePath:"in-active-path",active:"is-active",d_block:"d-block"},defaultAttrs:{type:"text",autocomplete:"off",readonly:"readonly"},html:{dropdown:function(e){let tabContent='<ul class="nav nav-tabs" role="tablist">  <li class="nav-item" id="nav_area_selector_country"><a class="nav-link" data-toggle="tab" href="#area_selector_country" role="tab" aria-selected="false">请选择</a></li>  <li class="nav-item" id="nav_area_selector_province"><a class="nav-link d-none" data-toggle="tab" href="#area_selector_province" role="tab" aria-selected="false">请选择</a></li>  <li class="nav-item" id="nav_area_selector_city"><a class="nav-link d-none" data-toggle="tab" href="#area_selector_city" role="tab" aria-selected="false">请选择</a></li>  <li class="nav-item" id="nav_area_selector_county"><a class="nav-link d-none" data-toggle="tab" href="#area_selector_county" role="tab" aria-selected="false">请选择</a></li>  <li class="nav-item" id="nav_area_selector_street"><a class="nav-link d-none" data-toggle="tab" href="#area_selector_street" role="tab" aria-selected="false">请选择</a></li></ul><div class="tab-content">  <div class="tab-pane fade" id="area_selector_country" role="tabpanel"><ul></ul></div>  <div class="tab-pane fade" id="area_selector_province" role="tabpanel"><ul></ul></div>  <div class="tab-pane fade" id="area_selector_city" role="tabpanel"><ul></ul></div>  <div class="tab-pane fade" id="area_selector_county" role="tabpanel"><ul></ul></div>  <div class="tab-pane fade" id="area_selector_street" role="tabpanel"><ul></ul></div></div>';return'<div class="input-suffix"><i class="iconfont icon-arrow-up"></i></div><div class="area-selector-dropdown el-popper" x-placement="bottom-start">  <div class="popper__arrow"></div>  <div class="area-selector-panel" id="areaSelector_panel_'+e+'">'+tabContent+"</div></div>"},li:function(f,e){return'<li data-id="'+f+'">'+e+"</li>"}}},defaults={idKey:"id",pIdKey:"parentId",rootPId:-1,name:"name",disabled:false,separator:" / ",type:"post",url:"",contentType:"application/json;charset=utf-8",dataType:"json",responseHandler:function(e){return e.data},success:function(e){},onClickNode:function(f,e){}},checkedNodes={},methods={getCheckedNodes:function(){return checkedNodes[this.targetId]||[]}};d.fn.extend({areaSelector:function(e){d(this).wrap('<div class="area-selector"></div>');if(e!==undefined&&typeof e!=="object"){return this}let $areaSelectorInput=d(this),targetId=$areaSelectorInput.attr("id"),classes=constants.classes,nodeObj={},param={},html=constants.html,config=d.extend({},defaults,e),treeSelect={targetId:targetId,config:config};$areaSelectorInput.attr(constants.defaultAttrs).after(html.dropdown(targetId));if(config.disabled){$areaSelectorInput.attr("disabled","disabled")}let $areaSelector=$areaSelectorInput.parent(".area-selector"),$areaSelector_dropdown=$areaSelectorInput.siblings(".area-selector-dropdown");param[config.pIdKey]=config.rootPId;d.ajax({type:config.type,data:config.contentType.indexOf("application/json")>-1?JSON.stringify(param):param,contentType:config.contentType,url:config.url,dataType:config.dataType,success:function(f){let lis="",nodes=config.responseHandler(f);d.each(nodes,function(g,h){let nodeId=h[config.idKey];lis+=html.li(nodeId,h[config.name]);nodeObj[d.trim(nodeId)]=h});d("#area_selector_country ul").html(lis);d("#nav_area_selector_country a").tab("show");config.success(f)}});$areaSelectorInput.on("click",function(){if(!$areaSelector.hasClass(classes.isFocus)){c($areaSelectorInput,$areaSelector_dropdown);$areaSelector_dropdown.addClass(classes.zoomInTopEnterActive).addClass(classes.zoomInTopEnter);$areaSelector.addClass(classes.isFocus);setTimeout(function(){$areaSelector_dropdown.removeClass(classes.zoomInTopEnter)},7);setTimeout(function(){$areaSelector_dropdown.removeClass(classes.zoomInTopEnterActive)},300)}else{a($areaSelector,$areaSelector_dropdown)}});$areaSelector_dropdown.on("click",".tab-content li",function(){let $this=d(this),name=$this.text(),node=nodeObj[d.trim($this.attr("data-id"))],nodeId=node[config.idKey];$this.addClass("active").siblings().removeClass("active");let tabId=$this.parents(".tab-pane").attr("id"),navId="nav_"+tabId;d("#"+navId+" .nav-link").text(name);config.onClickNode(this,node);if(navId==="nav_area_selector_street"){b(targetId,$areaSelectorInput,config,nodeObj);a($areaSelector,$areaSelector_dropdown)}else{param[config.pIdKey]=nodeId;d.ajax({type:config.type,data:config.contentType.indexOf("application/json")>-1?JSON.stringify(param):param,contentType:config.contentType,url:config.url,dataType:config.dataType,success:function(f){let lis="",nodes=config.responseHandler(f),$tab=d("#"+tabId);$tab.nextAll().html("<ul></ul>");d.each(nodes,function(g,h){let nodeId=h[config.idKey];lis+=html.li(nodeId,h[config.name]);nodeObj[d.trim(nodeId)]=h});$tab.next().find("ul").html(lis);d("#"+navId+"~ .nav-item .nav-link").addClass("d-none").text("请选择");if(d.isEmptyObject(nodes)){b(targetId,$areaSelectorInput,config,nodeObj);a($areaSelector,$areaSelector_dropdown)}else{d("#"+navId+" + .nav-item .nav-link").removeClass("d-none").click()}}})}});d(document).on("click",function(f){if(!$areaSelector.is(f.target)&&$areaSelector.has(f.target).length===0){if($areaSelector.hasClass(classes.isFocus)){a($areaSelector,$areaSelector_dropdown)}}});d(document).scroll(function(){c($areaSelectorInput,$areaSelector_dropdown)});methods.val=function(f){if(f===undefined){let values=[],config=this.config;d.each(checkedNodes[this.targetId],function(g,h){values.push(h[config.idKey])});return values}else{if(!d.isEmptyObject(f)){f.unshift(config.rootPId);for(let i=0;i<f.length;i++){param[config.pIdKey]=f[i];d.ajax({type:config.type,data:config.contentType.indexOf("application/json")>-1?JSON.stringify(param):param,contentType:config.contentType,url:config.url,dataType:config.dataType,success:function(g){let lis="",nodes=config.responseHandler(g),nodeId=f[i+1];d.each(nodes,function(h,j){let nodeId=j[config.idKey];lis+=html.li(nodeId,j[config.name]);nodeObj[d.trim(nodeId)]=j});d("#areaSelector_panel_"+targetId+" .tab-content .tab-pane").eq(i).find("ul").html(lis).find("li[data-id="+nodeId+"]").addClass("active");if(d.isEmptyObject(nodes)||nodeId===undefined){setTimeout(function(){d("#areaSelector_panel_"+targetId+" .nav-tabs .nav-item").eq(i-1).find(".nav-link").tab("show");b(targetId,$areaSelectorInput,config,nodeObj)},30)}else{d("#areaSelector_panel_"+targetId+" .nav-tabs .nav-item").eq(i).find(".nav-link").text(nodeObj[d.trim(nodeId)][config.name]).removeClass("d-none")}}})}}}};return d.extend({},treeSelect,methods)}});function c(f,e){if(f&&e&&f.length>0&&e.length>0){let bottom=d(window).height()-(f.offset().top-d(document).scrollTop());if(bottom<=250){e.attr("x-placement","top-start")}else{e.attr("x-placement","bottom-start")}}}function b(f,g,e,h){let names=[],nodes=[];d("#areaSelector_panel_"+f+" .tab-content li.active").each(function(j,k){names.push(d(k).text());nodes.push(h[d(k).attr("data-id")])});checkedNodes[f]=nodes;if(g.hasClass("is-invalid")){g.removeClass("is-invalid")}g.val(names.join(e.separator))}function a(f,e){if(f&&e&&f.length>0&&e.length>0){let classes=constants.classes;e.addClass(classes.zoomInTopLeaveActive).addClass(classes.d_block);f.removeClass(classes.isFocus);setTimeout(function(){e.removeClass(constants.classes.zoomInTopLeaveActive).removeClass(classes.d_block)},300)}}})(jQuery);