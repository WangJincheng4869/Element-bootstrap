/*!
 * treeSelect v1.0.3
 *
 * 作者：王金城
 * 日期：2019年11月12日
 */
(function(e){let constants={classes:{zoomInTopLeaveActive:"el-zoom-in-top-leave-active",zoomInTopEnter:"el-zoom-in-top-enter",zoomInTopEnterActive:"el-zoom-in-top-enter-active",isFocus:"is-focus",cascader:"cascader",elPopper:"el-popper",popperArrow:"popper__arrow",activePath:"in-active-path",active:"is-active",d_block:"d-block"},defaultAttrs:{type:"text",autocomplete:"off",readonly:"readonly"},html:{dropdown:function(g,h,j){let panel='<div class="tree-select-menu-wrap el-scrollbar__wrap" style="margin-right:'+h+";margin-bottom:"+j+';">  <ul class="el-scrollbar__view ztree" id="treeSelect_'+g+'"></ul></div><div class="el-scrollbar__bar is-horizontal"><div class="el-scrollbar__thumb"></div></div><div class="el-scrollbar__bar is-vertical"><div class="el-scrollbar__thumb"></div></div>';return'<div class="input-suffix"><i class="iconfont icon-arrow-up"></i></div><div class="tree-select-dropdown el-popper" x-placement="bottom-start">  <div class="popper__arrow"></div>  <div class="tree-select-panel el-scrollbar" id="treeSelect_panel_'+g+'">'+panel+"</div></div>"}}},defaults={idKey:"id",pIdKey:"pId",rootPId:-1,name:"name",disabled:false,onlySelectOne:true,chkboxType:{Y:"s",N:"s"},showIcon:false,separator:" / ",callback:{},view:{showIcon:false},beforeClick:function(j,h,g){},onClick:function(g,j,h){},onCheck:function(g,j,h){}},checkedNodes={},treeSelectObjs={},methods={val:function(g){if(g===undefined){let values=[],config=this.config;if(e.isEmptyObject(checkedNodes[this.targetId])){return config.onlySelectOne?null:[]}if(config.onlySelectOne){return checkedNodes[this.targetId][config.idKey]}e.each(checkedNodes[this.targetId],function(h,j){values.push(j[config.idKey])});return values}else{let targetId=this.targetId,config=this.config,$treeSelectInput=e("#"+targetId),treeObj=e.fn.zTree.getZTreeObj("treeSelect_"+targetId),placeholder=$treeSelectInput.attr("data-placeholder"),title=$treeSelectInput.attr("data-title");treeObj.checkAllNodes(false);checkedNodes={};if(placeholder){$treeSelectInput.attr("placeholder",placeholder)}if(title){$treeSelectInput.attr("title",title)}if(!e.isEmptyObject(g)&&!config.onlySelectOne){let valLength=g.length;for(let i=0;i<valLength;i++){let node=treeObj.getNodeByParam(config.idKey,g[i]);treeObj.checkNode(node,true,true,true);treeObj.selectNode(node)}}else{if(g!==null&&g!==""&&config.onlySelectOne){let node=treeObj.getNodeByParam(config.idKey,g);treeObj.selectNode(node);$treeSelectInput.attr("placeholder",node[config.name])}}}},getCheckedNodes:function(){if(this.config.onlySelectOne){return checkedNodes[this.targetId]||{}}return checkedNodes[this.targetId]||[]},getZTreeObj:function(){return e.fn.zTree.getZTreeObj("treeSelect_"+this.targetId)},reload:function(g){let zTreeObj=this.getZTreeObj(),rootNode=zTreeObj.getNodeByParam(this.config.pIdKey,this.config.rootPId);zTreeObj.removeChildNodes(rootNode);zTreeObj.removeNode(rootNode);zTreeObj.addNodes(null,g);if(this.config.onlySelectOne){this.val("")}else{this.val([])}}};e.fn.extend({treeSelect:function(g,h){e(this).wrap('<div class="tree-select"></div>');if(typeof g!=="object"){return this}let $treeSelectInput=e(this),targetId=$treeSelectInput.attr("id"),classes=constants.classes,placeholder=$treeSelectInput.attr("placeholder"),title=$treeSelectInput.attr("title"),html=constants.html,config=e.extend({},defaults,g),treeSelect={targetId:targetId,config:config},scrollbarWidthAndHeight=b(),scrollbarWidth=scrollbarWidthAndHeight[0],scrollbarHeight=scrollbarWidthAndHeight[1];if(placeholder){$treeSelectInput.attr("data-placeholder",placeholder)}if(title){$treeSelectInput.attr("data-title",title)}$treeSelectInput.attr(constants.defaultAttrs).after(html.dropdown(targetId,-scrollbarWidth+"px",-scrollbarHeight+"px"));if(config.disabled){$treeSelectInput.attr("disabled","disabled")}let $treeSelect=$treeSelectInput.parent(".tree-select"),$treeSelect_dropdown=$treeSelectInput.siblings(".tree-select-dropdown"),$input_suffix=$treeSelectInput.next(".input-suffix"),setting={view:config.view,data:{simpleData:{enable:true,idKey:config.idKey,pIdKey:config.pIdKey,rootPId:config.rootPId},key:{name:config.name}},check:{enable:!config.onlySelectOne,chkboxType:config.chkboxType},callback:config.callback};setting.callback.onCheck=function(j,l,k){let treeObj=e.fn.zTree.getZTreeObj(l),nodes=treeObj.getNodesByParam("checked",true),namesAry=[];checkedNodes[targetId]=nodes;e.each(nodes,function(m,n){namesAry.push(n[config.name])});let names=namesAry.join(config.separator);$treeSelectInput.attr("placeholder",names).attr("title",names);config.onCheck(j,l,k)};setting.callback.beforeClick=function(l,k,j){let treeObj=e.fn.zTree.getZTreeObj(l),nodes=treeObj.getSelectedNodes();e.each(nodes,function(m,n){treeObj.cancelSelectedNode(n)});config.beforeClick(l,k,j)};setting.callback.onClick=function(j,l,k){if(config.onlySelectOne){$treeSelectInput.attr("placeholder",k[config.name]);checkedNodes[targetId]=k;a($treeSelect,$treeSelect_dropdown)}config.onClick(j,l,k)};let treeSelectObj=e.fn.zTree.init(e("#treeSelect_"+targetId),setting,h),$scrollbar__wrap=e("#treeSelect_panel_"+targetId+" .el-scrollbar__wrap"),$scrollbar__thumb=e("#treeSelect_panel_"+targetId+" .el-scrollbar__bar.is-vertical .el-scrollbar__thumb"),wrapHeight=$scrollbar__wrap.height()-scrollbarHeight;d(targetId,$scrollbar__wrap,$scrollbar__thumb,scrollbarHeight,wrapHeight);$scrollbar__wrap.on("scroll",function(){$scrollbar__thumb.css("transform","translateY("+(e(this).scrollTop()/wrapHeight*100)+"%)")});$input_suffix.on("click",function(){if($treeSelect.hasClass(classes.isFocus)){a($treeSelect,$treeSelect_dropdown)}else{$treeSelectInput.click()}});$treeSelectInput.on("click",function(){if(!$treeSelect.hasClass(classes.isFocus)){c($treeSelectInput,$treeSelect_dropdown);$treeSelect_dropdown.addClass(classes.zoomInTopEnterActive).addClass(classes.zoomInTopEnter);$treeSelect.addClass(classes.isFocus);setTimeout(function(){$treeSelect_dropdown.removeClass(classes.zoomInTopEnter)},7);setTimeout(function(){$treeSelect_dropdown.removeClass(classes.zoomInTopEnterActive)},300);$treeSelectInput.removeAttr("readonly");treeSelectObj.showNodes(treeSelectObj.getNodesByParam("isHidden",true))}}).on("keyup",function(){let searchKey=e.trim(e(this).val());if(searchKey){treeSelectObj.expandAll(true);let showNodes=treeSelectObj.getNodesByParam("isHidden",false),nodes=treeSelectObj.getNodesByParamFuzzy(config.name,searchKey),hideParentNodes=[];treeSelectObj.hideNodes(showNodes);e.each(nodes,function(j,k){f(hideParentNodes,k)});treeSelectObj.showNodes(hideParentNodes);treeSelectObj.showNodes(nodes)}else{let hideNodes=treeSelectObj.getNodesByParam("isHidden",true);treeSelectObj.showNodes(hideNodes)}});e(document).on("click",function(j){if(!$treeSelect.is(j.target)&&$treeSelect.has(j.target).length===0){if($treeSelect.hasClass(classes.isFocus)){a($treeSelect,$treeSelect_dropdown)}}});e(document).scroll(function(){c($treeSelectInput,$treeSelectInput.siblings(".tree-select-dropdown"))});treeSelectObjs[targetId]=e.extend({},treeSelect,methods);return treeSelectObjs[targetId]}});e.fn.tree_select={getTreeSelectObj:function(g){let o=treeSelectObjs[g];return o?o:null}};function f(g,h){let pNode=h.getParentNode();if(pNode){if(pNode.isHidden){g.push(pNode)}f(g,pNode)}}function c(g,h){if(g&&h&&g.length>0&&h.length>0){let bottom=e(window).height()-(g.offset().top-e(document).scrollTop());if(bottom<=250){h.attr("x-placement","top-start")}else{h.attr("x-placement","bottom-start")}}}function a(h,g){if(h&&g&&h.length>0&&g.length>0){let classes=constants.classes;g.addClass(classes.zoomInTopLeaveActive).addClass(classes.d_block);h.removeClass(classes.isFocus);setTimeout(function(){g.removeClass(constants.classes.zoomInTopLeaveActive).removeClass(classes.d_block)},300);h.find("input").val("").attr("readonly","readonly")}}function d(k,g,j,l,h){let $scrollbar__view=e("#treeSelect_panel_"+k+" .el-scrollbar__view");if($scrollbar__view.length===0){return false}let viewHeight=$scrollbar__view[0].scrollHeight;if(h<viewHeight){j.css("height",(h/viewHeight*100)+"%")}setTimeout(function(){d(k,g,j,l,h)},10)}function b(){let el=document.createElement("p"),styles={width:"100px",height:"100px",overflow:"scroll"};for(let i in styles){el.style[i]=styles[i]}document.body.appendChild(el);let scrollBarWidth=el.offsetWidth-el.clientWidth,scrollBarHeight=el.offsetHeight-el.clientHeight;el.remove();return[scrollBarWidth,scrollBarHeight]}})(jQuery);